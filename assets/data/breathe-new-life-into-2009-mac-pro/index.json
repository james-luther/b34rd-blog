{"hash":"7eea66335e3101fb2bdf96a4df7b72a3d5630259","data":{"post":{"title":"Breathe New Life into 2009 Mac Pro","path":"/breathe-new-life-into-2009-mac-pro/","slug":"breathe-new-life-into-2009-mac-pro","datetime":"2018-10-04 00:00:00","content":"<p>The Mac Pro circa 2009 is an amazing machine. The case is too damn beautiful to not show off and to be honest, the hardware isn’t a slouch either! It was and is a desktop server, with the dual Xeon processors from Intel and up to 128 GB of RAM (after you update the firmware) the machine can go a long way for a LONG time. I originally purchased this for development. At the time I was doing a LOT of mobile research on iOS and MacOS in general. The common denominator for testing and developing was the need for Apple hardware. The price tag in 2009 wasn’t too bad either, for $2500 I was able to score an Apple Display and the Mac Pro with an ATI Radeon HD 5770, Dual 2.26 Quad Core Xeons, and 16 GB of RAM. Even at 2009 prices, that’s a steal!</p>\n<p>For easily two years this machine was a monster at every task I threw at it. Once I moved on to more Android-based security research I found MacOS was severely lacking. It was great for development but not for much else I did. This drove me to install Linux. I went with OpenSuSE because of the stability and how developer friendly it has always been (my opinion has since changed as I’m a die-hard Arch guy these days but that’s not the point here). Things were going great and research was rocking! Moving on another year or two life struck and kids happened. I was no longer able to spend evenings researching and the computer sat which brings me to today, 2018. I have a 9 (more like 10) year old computer that has the potential for new life. Here’s where we start…</p>\n<p>My plan is to install Arch and make this beast into a KVM server. I’m going to upgrade the RAM to 128GB and host virtual machines for Node-Red, Web services, Motion, Home Assistant, Plex, NextCloud, and probably make one for a NAS, and possibly a few others. Let’s get started…</p>\n<p>First, we need to get a copy of Arch. Head over to archlinux.org/download and grab a copy of the latest iso.</p>\n<p><img src=\"https://miro.medium.com/max/1400/1*49sHvnr4p0Vy32d0Rl5IYA.png\" alt=\"alt text\" title=\"Arch Linux Download Page\"></p>\n<p>Make sure after you’ve downloaded you verify the hash.</p>\n<p><img src=\"https://miro.medium.com/max/1400/1*2Ii7C0vqlMGjG8yV6u56MQ.png\" alt=\"alt text\"></p>\n<p>Now we can either burn the iso to a disk or copy to flash drive. I prefer the flash route.</p>\n<pre class=\"shiki\" style=\"background-color: #ffffff\"><code><span class=\"line\"><span style=\"color: #C2C3C5\"># dd if=/path/to/archlinux.iso of=/dev/my/usb/device bs=4M.</span></span></code></pre>\n<p>Upon completion, plug into the Mac, hold the option key, and boot up!</p>\n<p><img src=\"https://miro.medium.com/max/1400/1*mrWs53QTngfpwNqlJy2shw.jpeg\" alt=\"alt text\" title=\"Hold Option Key while Booting\"></p>\n<p>It may take a bit for the screen to display but eventually, you will get some boot options:</p>\n<p><img src=\"https://miro.medium.com/max/1400/1*IngJM5tr0MnAaAVHEQleEw.jpeg\" alt=\"alt text\" title=\"Boot Options\"></p>\n<p>Make sure you select the disc or the USB device you loaded your Arch iso onto. From here we are brought to a root terminal and can begin our install. For those who have never used Arch Linux in the past, the wiki is amazing. It is probably the BEST documented of any distribution of Linux and will help you in every way. Based on what you want to accomplish, the wiki will guide you through the remainder of the install. You can see it here: <a href=\"https://wiki.archlinux.org/index.php/installation_guide\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://wiki.archlinux.org/index.php/installation_guide</a>.</p>\n<p>Now, we have network connectivity and have set our timezone. Time for us to get started. Since we’re going to install an LVM RAID, we need to turn on smartctl for our devices. Just open up your favorite editor (I prefer vim) and edit /etc/smartd.conf. I added the following lines for my devices:</p>\n<p><img src=\"https://miro.medium.com/max/1400/1*Hmnl_3_YCxZwLhlMKUpFmA.png\" alt=\"alt text\" title=\"Adding devices to smartd\"></p>\n<p>Time to partition and set up our RAID. Depending on your version of Arch and fdisk, it may be different and since these drives have been used in the past, I’m just going to delete all partitions and set them up as Linux filesystem type. We need to make sure to create a ~200MB partition for EFI. When we make the EFI partition, set the type to 1, EFI. After this is created, execute “fdisk /dev/sdx” for your device and delete partitions (minus your EFI partition), create a new primary partition, and set the partition type, then finally write the changes. You will need to do this for every device you are adding to your LVM RAID.</p>\n<p><img src=\"https://miro.medium.com/max/1470/1*9oh7iRJerbkncyNTOdVM9w.png\" alt=\"alt text\" title=\"Creating our EFI filesystem\"></p>\n<p>Here is where I start doing things a little differently than the install wiki. Now, I use LVM on the array to setup volume groups… From there, we install our base system and continue. To do this we run</p>\n<pre class=\"shiki\" style=\"background-color: #ffffff\"><code><span class=\"line\"><span style=\"color: #C2C3C5\"># pvcreate /dev/sdx, vgcreate VolGroup00 /dev/sdx. </span></span></code></pre>\n<p>We will then verify everything with vgdisplay. After verifying we create our logical volume as raid 5 and use all the space available.</p>\n<p><img src=\"https://miro.medium.com/max/552/1*SC0hi8TdBwndc-5NFemSzA.png\" alt=\"alt text\" title=\"vgdisplay output\"></p>\n<p><img src=\"https://miro.medium.com/max/552/1*ZFBV88S9LjDhly5ATd2ruA.png\" alt=\"alt text\" title=\"lvcreate\"></p>\n<p><img src=\"https://miro.medium.com/max/1400/1*Hsz-w97H7_ywhpk3aJSMHA.png\" alt=\"alt text\" title=\"lvdisplay\"></p>\n<p>From here we mount everything and run pacstrap with our base package selection. First we mount our arch-root to /mnt and our EFI to /mnt/boot. This is accomplished by executing:</p>\n<pre class=\"shiki\" style=\"background-color: #ffffff\"><code><span class=\"line\"><span style=\"color: #C2C3C5\"># mount /dev/VolGroup00/arch-root /mnt</span></span>\n<span class=\"line\"><span style=\"color: #C2C3C5\"># mkdir /mnt/boot</span></span>\n<span class=\"line\"><span style=\"color: #C2C3C5\"># mount /dev/sda1 /mnt/boot</span></span></code></pre>\n<p>We need to run pacstrap to get our base installed. You can add any package groups along with this command but I prefer to just install the base and then select individual packages with pacman in chroot step.</p>\n<pre class=\"shiki\" style=\"background-color: #ffffff\"><code><span class=\"line\"><span style=\"color: #C2C3C5\"># pacstrap /mnt base </span></span></code></pre>\n<p><img src=\"https://miro.medium.com/max/1400/1*1pE4Lm2kxW8ne6LqfC5evQ.png\" alt=\"alt text\" title=\"pacstrap installing base\"></p>\n<p>Once complete, we generate our fstab.</p>\n<pre class=\"shiki\" style=\"background-color: #ffffff\"><code><span class=\"line\"><span style=\"color: #C2C3C5\"># genfstab -U /mnt &gt;&gt; /mnt/etc/fstab’. </span></span></code></pre>\n<p>Now we go into our chroot and finish up.</p>\n<pre class=\"shiki\" style=\"background-color: #ffffff\"><code><span class=\"line\"><span style=\"color: #C2C3C5\"># arch-chroot /mnt</span></span></code></pre>\n<p>We set our timezone, run hwclock, set locale, specify LANG and keymap. Then we configure networking and install our bootloader. These steps don’t differ from the Arch installation wiki until it comes to bootloader.</p>\n<p>Since this is a Mac we need to install intel-ucode package. This package is microcode for the processor. The BIOS updates will sort this out for you but, we aren’t able to update our bios. This is super important for us especially after spectre and meltdown updates were released.</p>\n<p><img src=\"https://miro.medium.com/max/1400/1*XO3wWmU94kBYtkXXEcAqYg.png\" alt=\"alt text\" title=\"install of intel-ucode package\"></p>\n<p>Let’s go ahead and install all the KVM packages and requirements. We need to verify the kernel installed supports virtualization. We can check with:</p>\n<pre class=\"shiki\" style=\"background-color: #ffffff\"><code><span class=\"line\"><span style=\"color: #C2C3C5\"># lsmod | grep kvm</span></span>\n<span class=\"line\"><span style=\"color: #C2C3C5\"># lsmod | grep virtio</span></span>\n<span class=\"line\"><span style=\"color: #C2C3C5\"># zgrep VIRTIO /proc/config.gz </span></span></code></pre>\n<p><img src=\"https://miro.medium.com/max/1400/1*BIsyJYXnIzNGoeGAcawLKQ.png\" alt=\"alt text\" title=\"checking kvm status\"></p>\n<p>From here we need to install the qemu package and libvirt package. I’m going with qemu-headless since this machine is going to run without a display and be managed remotely.</p>\n<p><img src=\"https://miro.medium.com/max/1400/1*R2g6T7zVqMoKGUwenaE4mA.png\" alt=\"alt text\" title=\"qemu installation\"></p>\n<p>Once complete you will see a few additional packages suggested. If you feel the need for them, go for it. It all depends on your system. I installed samba as well as the qemu extras.</p>\n<p><img src=\"https://miro.medium.com/max/1400/1*GhGZvA36wVIp0SbLhBlM8g.png\" alt=\"alt text\" title=\"qemu extras\"></p>\n<p>The last thing I’m going to do is create a general user and setup sshd. To add my user, run:</p>\n<pre class=\"shiki\" style=\"background-color: #ffffff\"><code><span class=\"line\"><span style=\"color: #C2C3C5\"># useradd -m -g users -G wheel,storage,power -s /bin/bash username</span></span>\n<span class=\"line\"><span style=\"color: #C2C3C5\"># passwd username</span></span>\n<span class=\"line\"><span style=\"color: #C2C3C5\"># pacman -S sudo</span></span>\n<span class=\"line\"><span style=\"color: #C2C3C5\"># vi /etc/sudoers</span></span>\n<span class=\"line\"><span style=\"color: #C2C3C5\"># uncomment the line below:</span></span>\n<span class=\"line\"><span style=\"color: #24292EFF\">%wheel ALL=(ALL) ALL</span></span></code></pre>\n<p>Next, we need to install openssh.</p>\n<pre class=\"shiki\" style=\"background-color: #ffffff\"><code><span class=\"line\"><span style=\"color: #C2C3C5\"># pacman -S openssh </span></span>\n<span class=\"line\"><span style=\"color: #24292EFF\"> - Next we edit our sshd config</span></span>\n<span class=\"line\"><span style=\"color: #C2C3C5\"># vi /etc/ssh/sshd_config</span></span></code></pre>\n<p>Here there are only a few things we need to specify, our listen address, listen port, users allowed, and to disable root login.</p>\n<p>After we make our edits we enable the service…</p>\n<pre class=\"shiki\" style=\"background-color: #ffffff\"><code><span class=\"line\"><span style=\"color: #C2C3C5\"># systemctl enable sshd.service</span></span></code></pre>\n<p><img src=\"https://miro.medium.com/max/552/1*OxWwK3vgM0liljAhMbvG0w.png\" alt=\"alt text\" title=\"install openssh\"></p>\n<p><img src=\"https://miro.medium.com/max/552/1*wbFE_ECx8ktNIgjNboSW0w.png\" alt=\"alt text\" title=\"uncomment listen port and address\"></p>\n<p><img src=\"https://miro.medium.com/max/1400/1*HHIZjZii-Xps2v0bcGMoww.png\" alt=\"alt text\" title=\"specify users and disable root in sshd\"></p>\n<p>Now that we’ve finished all of this let’s setup the ramfs and our bootloader.</p>\n<p>To begin we need to add some lvm items to /etc/mkinitcpio.conf.</p>\n<pre class=\"shiki\" style=\"background-color: #ffffff\"><code><span class=\"line\"><span style=\"color: #C2C3C5\"># vi /etc/mkinitcpio.conf</span></span>\n<span class=\"line\"><span style=\"color: #24292EFF\"> -- We need to add systemd and sd-lvm2 to the HOOKS section --</span></span>\n<span class=\"line\"><span style=\"color: #24292EFF\"> -- We also need to add dm-raid raid0 raid1 raid10 raid456 to the MODULES section --</span></span></code></pre>\n<p><img src=\"https://miro.medium.com/max/1400/1*Xfg1uI5EpHAaWL2fT00hHg.png\" alt=\"alt text\" title=\"adding items to hooks\"></p>\n<p>Once we save we can generate run:</p>\n<pre class=\"shiki\" style=\"background-color: #ffffff\"><code><span class=\"line\"><span style=\"color: #C2C3C5\"># mkinitcpio -p linux</span></span></code></pre>\n<p>Lastly, we install our systemd bootloader and configure it. This is done with two commands:</p>\n<pre class=\"shiki\" style=\"background-color: #ffffff\"><code><span class=\"line\"><span style=\"color: #C2C3C5\"># bootctl --path=/boot install</span></span>\n<span class=\"line\"><span style=\"color: #C2C3C5\"># bootctl --path=/boot update</span></span></code></pre>\n<p>Reboot and enjoy!</p>\n<p>Arch can be a bit intense for an install but it is well worth it when finished.</p>\n<p>References:\nS.M.A.R.T. - ArchWiki\nS.M.A.R.T. (Self-Monitoring, Analysis, and Reporting Technology) is a supplementary component built into many modern…\nwiki.archlinux.org\nInstallation guide - ArchWiki\nThis document is a guide for installing Arch Linux from the live system booted with the official installation image…\nwiki.archlinux.org\nLVM - ArchWiki\nVirtual partitions allow addition and removal without worry of whether you have enough contiguous space on a particular…\nwiki.archlinux.org\nGRUB - ArchWiki\nGRUB (GRand Unified Bootloader) is a multi-boot loader. It is derived from PUPA which was a research project to develop…\nwiki.archlinux.org\nMicrocode - ArchWiki\nProcessor manufacturers release stability and security updates to the processor microcode. While microcode can be…\nwiki.archlinux.org\nEFI system partition - ArchWiki\nAccording to a Microsoft note[2], the minimum size for the EFI system partition (ESP) would be 100 MiB, though this is…\nwiki.archlinux.org\nMeltdown and Spectre\nMeltdown and Spectre exploit critical vulnerabilities in modern processors. These hardware vulnerabilities allow…\nmeltdownattack.com\nKVM - ArchWiki\nKVM, Kernel-based Virtual Machine, is a hypervisor built into the Linux kernel. It is similar to Xen in purpose but…\nwiki.archlinux.org\nQEMU - ArchWiki\nWhen used as a machine emulator, QEMU can run OSes and programs made for one machine (e.g. an ARM board) on a different…\nwiki.archlinux.org</p>\n","description":"Taking an old Mac Pro from 2009 and repurposing with Arch and ZFS","timeToRead":7,"cover":"https://miro.medium.com/max/1400/1*AV6cNtyNeiuQBfkxau3Z0A.jpeg","author":{"id":"b34rd","title":"b34rd","path":"/author/b34rd/"},"tags":[{"id":"arch","title":"arch","path":"/tag/arch/"},{"id":"mac pro","title":"mac pro","path":"/tag/mac%20pro/"},{"id":"zfs","title":"zfs","path":"/tag/zfs/"}]}},"context":{}}